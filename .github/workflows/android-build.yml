name: Build Flutter APK from Source Zip

on:
  workflow_dispatch:
    inputs:
      password:
        description: 'Enter the build password to proceed'
        required: true

jobs:
  build-android:
    if: ${{ github.event.inputs.password == '1234' }}
    runs-on: ubuntu-latest

    steps:
      # 1. Check out the repository to access the source.zip file
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Set up Java environment - UPDATED TO VERSION 17
      - name: Set up Java Development Kit
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17' # <-- THIS IS THE FIX

      # 3. Set up Flutter environment
      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 4. Create a clean, valid Flutter project structure
      - name: Create Flutter Project Skeleton
        run: flutter create --org com.shadow ping

      # 5. Unzip the source code into a temporary directory
      - name: Extract Source Code
        run: unzip source.zip -d temp_source

      # 6. Copy your custom files into the new project, overwriting the defaults
      - name: Integrate Custom App Code
        run: cp -r temp_source/ping/* ping/

      # 7. Get dependencies for the complete project
      - name: Get Flutter Dependencies
        working-directory: ./ping 
        run: flutter pub get
        
      # 8. Build the release APK
      - name: Build Release APK
        working-directory: ./ping
        run: flutter build apk --release

      # 9. Upload the generated APK as a downloadable artifact
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ping-Android-Release-APK
          path: ping/build/app/outputs/flutter-apk/app-release.apk
